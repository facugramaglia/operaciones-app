<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sistema de Operaciones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        button {
            -webkit-appearance: none;
            appearance: none;
            border: none;
            outline: none;
        }
        
        /* LOGIN */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .login-logo h1 {
            font-size: 28px;
            color: #667eea;
            margin-bottom: 5px;
            text-align: center;
        }
        
        .login-logo p {
            color: #718096;
            font-size: 14px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 14px;
        }
        
        .input-group select,
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
        }
        
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-link {
            background: none;
            border: none;
            color: #667eea;
            font-size: 13px;
            text-decoration: underline;
            padding: 10px;
            margin-top: 15px;
            display: block;
            text-align: center;
            width: 100%;
        }
        
        /* APP */
        .app-container {
            display: none;
        }
        
        .app-header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .btn-logout {
            padding: 8px 16px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
            margin-top: 10px;
        }
        
        .balance-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .balance-amount {
            font-size: 32px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 max(10px, env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: #718096;
            border: none;
            background: none;
            font-size: 12px;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        /* CONTENT */
        .content {
            padding: 20px 20px calc(80px + env(safe-area-inset-bottom)) 20px;
        }
        
        .content .balance-card {
            margin-bottom: 20px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .stat-sub {
            font-size: 11px;
            color: #a0aec0;
            margin-top: 4px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        /* FORM */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .tipo-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tipo-btn {
            padding: 15px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .tipo-btn.active {
            background: #48bb78;
            color: white;
            border-color: #48bb78;
        }
        
        .tipo-btn.compra.active {
            background: #f56565;
            border-color: #f56565;
        }
        
        .btn-submit {
            width: 100%;
            padding: 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .btn-submit.compra {
            background: #f56565;
        }
        
        /* HISTORIAL */
        .operations-header {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .filter-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-bottom: 3px solid transparent;
            background: transparent;
            border-radius: 0;
            font-size: 15px;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: transparent;
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 10px 5px;
            color: #718096;
            border-bottom: 2px solid #e2e8f0;
            background: #f7fafc;
        }
        
        td {
            padding: 10px 5px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .estado-select {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            width: 100%;
        }
        
        .obs-box {
            background: #fef5e7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 11px;
            color: #92400e;
            max-width: 150px;
            word-wrap: break-word;
        }
        
        .total-preview {
            background: #e6f4ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .total-preview-label {
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
        }
        
        .total-preview-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            margin-top: 5px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- PIN SCREEN -->
    <div id="pin-screen" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <h1>üîê Acceso Seguro</h1>
                <p>Ingresa el PIN de acceso</p>
            </div>
            
            <div class="input-group">
                <label>PIN (4 d√≠gitos)</label>
                <input type="password" id="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" pattern="[0-9]*">
            </div>
            
            <button class="btn-primary" id="btn-pin">Continuar</button>
        </div>
    </div>
    
    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="login-container hidden">
        <div class="login-card">
            <div class="login-logo">
                <h1>üí± Operaciones</h1>
                <p>Inicia sesi√≥n para continuar</p>
            </div>
            
            <div class="input-group">
                <label>Operador</label>
                <select id="login-user">
                    <option value="">Selecciona tu usuario</option>
                    <option value="TOMI">TOMI</option>
                    <option value="CHOKI">CHOKI</option>
                    <option value="TURCO">TURCO</option>
                    <option value="AGU">AGU</option>
                    <option value="X3">X3</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="login-password" placeholder="Ingresa tu contrase√±a">
            </div>
            
            <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
            <button class="btn-link" id="btn-reconfig">‚öôÔ∏è Configurar API Key</button>
        </div>
    </div>
    
    <!-- MAIN APP -->
    <div id="main-app" class="app-container">
        <div class="app-header">
            <div class="header-top">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar"></div>
                    <div>
                        <div style="font-weight: 600; color: #2d3748;" id="user-name"></div>
                        <div style="font-size: 12px; color: #a0aec0;">Operador</div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600;" id="btn-config-header">‚öôÔ∏è</button>
                    <button class="btn-logout" id="btn-logout">Salir</button>
                </div>
            </div>
        </div>
        
        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboard-screen" class="screen active">
                <!-- Balance Card with Date/Time -->
                <div class="balance-card" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="balance-label">Balance Total</div>
                        <div class="balance-amount" id="header-balance-main">$0</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; opacity: 0.8;" id="current-date">--/--/----</div>
                        <div style="font-size: 20px; font-weight: bold; margin-top: 5px;" id="current-time">--:--</div>
                    </div>
                </div>
                
                <!-- Ventas Pendientes -->
                <div class="card">
                    <div class="card-title" style="color: #48bb78;">üìà Ventas Pendientes</div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Operador</th>
                                    <th>Cliente</th>
                                    <th style="text-align: right;">Cantidad</th>
                                </tr>
                            </thead>
                            <tbody id="ventas-pendientes-tbody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Compras Pendientes -->
                <div class="card">
                    <div class="card-title" style="color: #f56565;">üìâ Compras Pendientes</div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Operador</th>
                                    <th>Cliente</th>
                                    <th style="text-align: right;">Cantidad</th>
                                </tr>
                            </thead>
                            <tbody id="compras-pendientes-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- CARGAR -->
            <div id="cargar-screen" class="screen">
                <div class="card">
                    <div class="card-title">Nueva Operaci√≥n</div>
                    
                    <div class="tipo-buttons">
                        <button class="tipo-btn active" id="tipo-venta">‚¨ÜÔ∏è VENTA</button>
                        <button class="tipo-btn compra" id="tipo-compra">‚¨áÔ∏è COMPRA</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-input" id="form-fecha">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Cliente</label>
                        <input type="text" class="form-input" id="form-cliente" placeholder="Nombre del cliente">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Cantidad (USD)</label>
                        <input type="number" class="form-input" id="form-cantidad" placeholder="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Precio (ARS)</label>
                        <input type="number" class="form-input" id="form-precio" placeholder="0.00" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-textarea" id="form-observaciones" rows="3" placeholder="Notas adicionales"></textarea>
                    </div>
                    
                    <div id="total-preview" class="total-preview hidden">
                        <div class="total-preview-label">Total calculado:</div>
                        <div class="total-preview-value" id="total-preview-value">$0</div>
                    </div>
                    
                    <button class="btn-submit" id="btn-submit">Registrar VENTA</button>
                </div>
            </div>
            
            <!-- HISTORIAL -->
            <div id="historial-screen" class="screen">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <button class="filter-btn active" id="tab-ventas">üìà Ventas</button>
                    <button class="filter-btn" id="tab-compras">üìâ Compras</button>
                    <select id="filter-select" style="margin-left: auto; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; color: #667eea; background: white;">
                        <option value="ultimo">√öltimo d√≠a</option>
                        <option value="10">√öltimas 10</option>
                        <option value="20">√öltimas 20</option>
                        <option value="30">√öltimas 30</option>
                    </select>
                </div>
                
                <div id="ventas-tab" class="card">
                    <div class="card-title">√öltimas Ventas</div>
                    <div style="overflow-x: auto;">
                        <table id="ventas-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th style="text-align: right;">Cant</th>
                                    <th style="text-align: right;">Precio</th>
                                    <th style="text-align: right;">Total</th>
                                    <th>Estado</th>
                                    <th>Obs</th>
                                </tr>
                            </thead>
                            <tbody id="ventas-tbody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="compras-tab" class="card hidden">
                    <div class="card-title">√öltimas Compras</div>
                    <div style="overflow-x: auto;">
                        <table id="compras-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th style="text-align: right;">Cant</th>
                                    <th style="text-align: right;">Precio</th>
                                    <th style="text-align: right;">Total</th>
                                    <th>Estado</th>
                                    <th>Obs</th>
                                </tr>
                            </thead>
                            <tbody id="compras-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- CONFIG -->
            <div id="config-screen" class="screen">
                <div class="card">
                    <div class="card-title">‚öôÔ∏è Configuraci√≥n</div>
                    
                    <div class="form-group">
                        <label class="form-label">Google Sheets API Key</label>
                        <input type="text" class="form-input" id="config-api-key" placeholder="AIzaSy...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">URL del Google Apps Script</label>
                        <input type="text" class="form-input" id="config-script-url" placeholder="https://script.google.com/macros/s/.../exec">
                        <small style="font-size: 11px; color: #718096; margin-top: 5px; display: block;">
                            Debe terminar en /exec
                        </small>
                    </div>
                    
                    <div class="alert-success hidden" id="config-success">
                        ‚úÖ Configuraci√≥n guardada correctamente
                    </div>
                    
                    <button class="btn-primary" id="btn-save-config">Guardar Cambios</button>
                    
                    <button style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 14px; margin-top: 10px;" id="btn-test-script">
                        üß™ Probar conexi√≥n con Script
                    </button>
                </div>
            </div>
        </div>
        
        <div class="bottom-nav">
            <button class="nav-item active" id="nav-dashboard">
                <div class="nav-icon">üìä</div>
                <div>Dashboard</div>
            </button>
            <button class="nav-item" id="nav-cargar">
                <div class="nav-icon">‚ûï</div>
                <div>Cargar</div>
            </button>
            <button class="nav-item" id="nav-historial">
                <div class="nav-icon">üìã</div>
                <div>Historial</div>
            </button>
        </div>
    </div>
    
    <script>
        let config = {
            apiKey: localStorage.getItem('apiKey') || '',
            sheetId: '1Fn3iiKSMeDH8PAh1C-8SSLrcuikOSHTx7-ZIZXqeDnE',
            ventasRange: 'VENTAS!A2:M1000',
            comprasRange: 'COMPRAS!A2:M1000',
            balanceCell: 'CALCULO!D3',
            scriptUrl: localStorage.getItem('scriptUrl') || '',
            separador: '---SEPARADOR---'
        };
        
        const USERS = {
            'TOMI': 'TOMI',
            'CHOKI': 'CHOKI',
            'TURCO': 'TURCO',
            'AGU': 'AGU',
            'X3': 'X3'
        };
        
        const MASTER_PIN = '7994';
        
        let currentUser = null;
        let ventas = [];
        let compras = [];
        let ventasRaw = [];
        let comprasRaw = [];
        let balanceTotal = 0;
        let currentTipo = 'VENTA';
        let currentFilter = 'ultimo';
        let currentTab = 'ventas';
        
        // INIT
        window.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('form-fecha').value = today;
            
            setupEventListeners();
            
            // Check if PIN already verified
            const pinVerified = localStorage.getItem('pinVerified');
            if (pinVerified === 'true') {
                document.getElementById('pin-screen').classList.add('hidden');
                checkInitialSetup();
            }
            // Otherwise show PIN screen (already visible by default)
        });
        
        function setupEventListeners() {
            // PIN
            document.getElementById('btn-pin').addEventListener('click', checkPIN);
            document.getElementById('pin-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkPIN();
            });
            
            // Login
            document.getElementById('btn-login').addEventListener('click', handleLogin);
            document.getElementById('btn-reconfig').addEventListener('click', showConfigPrompt);
            document.getElementById('login-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Nav
            document.getElementById('nav-dashboard').addEventListener('click', () => showScreen('dashboard'));
            document.getElementById('nav-cargar').addEventListener('click', () => showScreen('cargar'));
            document.getElementById('nav-historial').addEventListener('click', () => showScreen('historial'));
            
            // Config button in header
            document.getElementById('btn-config-header').addEventListener('click', () => showScreen('config'));
            
            // Logout
            document.getElementById('btn-logout').addEventListener('click', handleLogout);
            
            // Tipo
            document.getElementById('tipo-venta').addEventListener('click', () => setTipo('VENTA'));
            document.getElementById('tipo-compra').addEventListener('click', () => setTipo('COMPRA'));
            
            // Form
            document.getElementById('form-cantidad').addEventListener('input', calcularTotal);
            document.getElementById('form-precio').addEventListener('input', calcularTotal);
            document.getElementById('btn-submit').addEventListener('click', agregarOperacion);
            
            // Historial tabs
            document.getElementById('tab-ventas').addEventListener('click', () => switchTab('ventas'));
            document.getElementById('tab-compras').addEventListener('click', () => switchTab('compras'));
            
            // Filter dropdown
            document.getElementById('filter-select').addEventListener('change', function() {
                const value = this.value;
                changeFilter(value === 'ultimo' ? 'ultimo' : parseInt(value));
            });
            
            // Config
            document.getElementById('btn-save-config').addEventListener('click', saveConfig);
            document.getElementById('btn-test-script').addEventListener('click', testScriptConnection);
        }
        
        function checkPIN() {
            const pin = document.getElementById('pin-input').value;
            
            if (pin === MASTER_PIN) {
                localStorage.setItem('pinVerified', 'true');
                document.getElementById('pin-screen').classList.add('hidden');
                checkInitialSetup();
            } else {
                alert('‚ùå PIN incorrecto');
                document.getElementById('pin-input').value = '';
            }
        }
        
        function checkInitialSetup() {
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedUser && config.apiKey) {
                currentUser = savedUser;
                showMainApp();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }
        
        function showConfigPrompt() {
            const apiKey = prompt('Google Sheets API Key:');
            if (!apiKey || !apiKey.trim()) {
                alert('‚ùå La API Key es obligatoria');
                return;
            }
            
            config.apiKey = apiKey.trim();
            localStorage.setItem('apiKey', config.apiKey);
            
            const scriptUrl = prompt('URL del Google Apps Script (opcional):');
            if (scriptUrl && scriptUrl.trim()) {
                config.scriptUrl = scriptUrl.trim();
                localStorage.setItem('scriptUrl', config.scriptUrl);
            }
            
            alert('‚úÖ Configuraci√≥n guardada');
        }
        
        function handleLogin() {
            const username = document.getElementById('login-user').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('Completa todos los campos');
                return;
            }
            
            if (!config.apiKey) {
                alert('Configura tu API Key primero');
                showConfigPrompt();
                return;
            }
            
            if (USERS[username] && USERS[username] === password) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                showMainApp();
            } else {
                alert('‚ùå Usuario o contrase√±a incorrectos');
            }
        }
        
        function handleLogout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('pinVerified');
            currentUser = null;
            document.getElementById('pin-screen').classList.remove('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('pin-input').value = '';
            document.getElementById('login-user').value = '';
            document.getElementById('login-password').value = '';
        }
        
        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').style.display = 'block';
            
            document.getElementById('user-avatar').textContent = currentUser[0];
            document.getElementById('user-name').textContent = currentUser;
            document.getElementById('config-api-key').value = config.apiKey;
            document.getElementById('config-script-url').value = config.scriptUrl;
            
            loadData();
        }
        
        async function loadData() {
            try {
                const balanceUrl = `https://sheets.googleapis.com/v4/spreadsheets/${config.sheetId}/values/${config.balanceCell}?key=${config.apiKey}`;
                const balanceRes = await fetch(balanceUrl);
                const balanceData = await balanceRes.json();
                
                if (balanceData.values && balanceData.values[0]) {
                    const balanceStr = String(balanceData.values[0][0]).replace(/\$/g, '').replace(/,/g, '').trim();
                    balanceTotal = parseFloat(balanceStr) || 0;
                }
                
                const ventasUrl = `https://sheets.googleapis.com/v4/spreadsheets/${config.sheetId}/values/${config.ventasRange}?key=${config.apiKey}`;
                const ventasRes = await fetch(ventasUrl);
                const ventasData = await ventasRes.json();
                ventasRaw = ventasData.values || [];
                ventas = processData(ventasRaw);
                
                const comprasUrl = `https://sheets.googleapis.com/v4/spreadsheets/${config.sheetId}/values/${config.comprasRange}?key=${config.apiKey}`;
                const comprasRes = await fetch(comprasUrl);
                const comprasData = await comprasRes.json();
                comprasRaw = comprasData.values || [];
                compras = processData(comprasRaw);
                
                updateUI();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar datos');
            }
        }
        
        function processData(rows) {
            return rows
                .filter(row => {
                    if (!row || row.length === 0) return false;
                    if (!row[1] || !row[3]) return false;
                    // Filtrar filas que son separadores (con o sin guiones)
                    const operador = String(row[1]).trim();
                    if (operador === '---SEPARADOR---' || operador === 'SEPARADOR' || operador.includes('SEPARADOR')) return false;
                    return true;
                })
                .map((row, index) => {
                    const cantidadStr = String(row[3] || '0').replace(/\$/g, '').replace(/,/g, '').trim();
                    const precioStr = String(row[4] || '0').replace(/\$/g, '').replace(/,/g, '').trim();
                    const totalStr = String(row[5] || '0').replace(/\$/g, '').replace(/,/g, '').trim();
                    
                    let timestamp = null;
                    if (row[10]) {
                        const tsValue = row[10];
                        if (typeof tsValue === 'number') {
                            timestamp = new Date((tsValue - 25569) * 86400 * 1000);
                        } else {
                            timestamp = new Date(tsValue);
                        }
                        if (isNaN(timestamp.getTime())) timestamp = null;
                    }
                    
                    return {
                        fecha: String(row[0] || '').trim(),
                        operador: String(row[1] || '').trim().toUpperCase(),
                        cliente: String(row[2] || '').trim(),
                        cantidad: parseFloat(cantidadStr) || 0,
                        precio: parseFloat(precioStr) || 0,
                        total: parseFloat(totalStr) || 0,
                        estado: String(row[6] || 'PENDIENTE').trim(),
                        observaciones: String(row[7] || '').trim(),
                        timestamp: timestamp,
                        modificadoPor: String(row[11] || '').trim(),
                        fechaModificacion: String(row[12] || '').trim()
                    };
                });
        }
        
        function updateUI() {
            // Update balance with color in dashboard
            const balanceElement = document.getElementById('header-balance-main');
            balanceElement.textContent = '$' + balanceTotal.toLocaleString('es-AR');
            
            // Color verde si positivo, rojo si negativo
            if (balanceTotal >= 0) {
                balanceElement.style.color = '#48bb78'; // Verde
            } else {
                balanceElement.style.color = '#f56565'; // Rojo
            }
            
            // Update date and time
            updateDateTime();
            
            // Update pending tables
            updatePendingTables();
            
            updateHistorial();
        }
        
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            
            document.getElementById('current-date').textContent = now.toLocaleDateString('es-AR', dateOptions);
            document.getElementById('current-time').textContent = now.toLocaleTimeString('es-AR', timeOptions);
            
            // Update every minute
            setTimeout(updateDateTime, 60000);
        }
        
        function updatePendingTables() {
            // Filtrar solo operaciones PENDIENTES
            const ventasPendientes = ventas.filter(v => v.estado.toUpperCase() === 'PENDIENTE');
            const comprasPendientes = compras.filter(c => c.estado.toUpperCase() === 'PENDIENTE');
            
            // Ventas Pendientes
            const ventasTbody = document.getElementById('ventas-pendientes-tbody');
            ventasTbody.innerHTML = '';
            
            if (ventasPendientes.length === 0) {
                const row = ventasTbody.insertRow();
                row.innerHTML = '<td colspan="3" style="text-align: center; color: #a0aec0; padding: 20px;">No hay ventas pendientes</td>';
            } else {
                ventasPendientes.forEach(v => {
                    const row = ventasTbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${v.operador}</strong></td>
                        <td>${v.cliente}</td>
                        <td style="text-align: right; font-weight: 600; color: #48bb78;">$${v.cantidad.toLocaleString('es-AR')}</td>
                    `;
                });
            }
            
            // Compras Pendientes
            const comprasTbody = document.getElementById('compras-pendientes-tbody');
            comprasTbody.innerHTML = '';
            
            if (comprasPendientes.length === 0) {
                const row = comprasTbody.insertRow();
                row.innerHTML = '<td colspan="3" style="text-align: center; color: #a0aec0; padding: 20px;">No hay compras pendientes</td>';
            } else {
                comprasPendientes.forEach(c => {
                    const row = comprasTbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${c.operador}</strong></td>
                        <td>${c.cliente}</td>
                        <td style="text-align: right; font-weight: 600; color: #f56565;">$${c.cantidad.toLocaleString('es-AR')}</td>
                    `;
                });
            }
        }
        
        function getFilteredOps(ops, isVentas) {
            if (currentFilter === 'ultimo') {
                // Buscar el √öLTIMO separador en los datos RAW
                const rawData = isVentas ? ventasRaw : comprasRaw;
                let lastSepIndex = -1;
                
                for (let i = rawData.length - 1; i >= 0; i--) {
                    if (rawData[i] && rawData[i][1]) {
                        const operador = String(rawData[i][1]).trim();
                        if (operador === '---SEPARADOR---' || operador.includes('SEPARADOR')) {
                            lastSepIndex = i;
                            break;
                        }
                    }
                }
                
                // Si encontramos separador, necesitamos mapear √≠ndices
                if (lastSepIndex >= 0) {
                    // Contar cu√°ntas filas v√°lidas hay antes del separador
                    let validRowsBeforeSep = 0;
                    for (let i = 0; i < lastSepIndex; i++) {
                        const row = rawData[i];
                        if (row && row[1] && row[3]) {
                            const op = String(row[1]).trim();
                            if (op !== '---SEPARADOR---' && !op.includes('SEPARADOR')) {
                                validRowsBeforeSep++;
                            }
                        }
                    }
                    // Devolver operaciones despu√©s de ese √≠ndice
                    return ops.slice(validRowsBeforeSep);
                }
                
                return ops;
            }
            return ops.slice(-currentFilter);
        }
        
        function updateHistorial() {
            const estadosVentas = ['PENDIENTE', 'REALIZADA', 'LLEVO BILLETES'];
            const estadosCompras = ['PENDIENTE', 'REALIZADA', 'LLEVO PESOS', 'PREPARADO'];
            
            const ventasTbody = document.getElementById('ventas-tbody');
            const comprasTbody = document.getElementById('compras-tbody');
            
            ventasTbody.innerHTML = '';
            comprasTbody.innerHTML = '';
            
            const ventasFiltradas = getFilteredOps(ventas, true).reverse();
            const comprasFiltradas = getFilteredOps(compras, false).reverse();
            
            ventasFiltradas.forEach((v, idx) => {
                const row = ventasTbody.insertRow();
                const estadoColor = getEstadoColor(v.estado);
                
                row.innerHTML = `
                    <td style="font-size: 11px;">${v.fecha}</td>
                    <td>
                        <div style="font-weight: 600;">${v.cliente}</div>
                        <div style="font-size: 10px; color: #a0aec0;">${v.operador}</div>
                    </td>
                    <td style="text-align: right;">$${v.cantidad}</td>
                    <td style="text-align: right; font-size: 11px;">$${v.precio.toFixed(2)}</td>
                    <td style="text-align: right; font-weight: 600; color: #48bb78;">$${v.total.toLocaleString('es-AR')}</td>
                    <td>
                        <select class="estado-select" data-tipo="VENTA" data-fecha="${v.fecha}" data-cliente="${v.cliente}" data-cantidad="${v.cantidad}" style="border: 1px solid ${estadoColor}; background: ${estadoColor}20; color: ${estadoColor};">
                            ${estadosVentas.map(e => `<option value="${e}" ${v.estado === e ? 'selected' : ''}>${e}</option>`).join('')}
                        </select>
                    </td>
                    <td>${v.observaciones ? `<div class="obs-box">${v.observaciones}</div>` : ''}</td>
                `;
            });
            
            comprasFiltradas.forEach((c, idx) => {
                const row = comprasTbody.insertRow();
                const estadoColor = getEstadoColor(c.estado);
                
                row.innerHTML = `
                    <td style="font-size: 11px;">${c.fecha}</td>
                    <td>
                        <div style="font-weight: 600;">${c.cliente}</div>
                        <div style="font-size: 10px; color: #a0aec0;">${c.operador}</div>
                    </td>
                    <td style="text-align: right;">$${c.cantidad}</td>
                    <td style="text-align: right; font-size: 11px;">$${c.precio.toFixed(2)}</td>
                    <td style="text-align: right; font-weight: 600; color: #f56565;">$${c.total.toLocaleString('es-AR')}</td>
                    <td>
                        <select class="estado-select" data-tipo="COMPRA" data-fecha="${c.fecha}" data-cliente="${c.cliente}" data-cantidad="${c.cantidad}" style="border: 1px solid ${estadoColor}; background: ${estadoColor}20; color: ${estadoColor};">
                            ${estadosCompras.map(e => `<option value="${e}" ${c.estado === e ? 'selected' : ''}>${e}</option>`).join('')}
                        </select>
                    </td>
                    <td>${c.observaciones ? `<div class="obs-box">${c.observaciones}</div>` : ''}</td>
                `;
            });
            
            // Add event listeners to all estado selects
            document.querySelectorAll('.estado-select').forEach(select => {
                select.addEventListener('change', function(e) {
                    cambiarEstado(e.target);
                });
            });
        }
        
        function getEstadoColor(estado) {
            const colors = {
                'PENDIENTE': '#f59e0b',
                'REALIZADA': '#48bb78',
                'LLEVO BILLETES': '#667eea',
                'LLEVO PESOS': '#667eea',
                'PREPARADO': '#9333ea'
            };
            return colors[estado] || '#718096';
        }
        
        async function cambiarEstado(selectElement) {
            if (!config.scriptUrl) {
                alert('‚ö†Ô∏è Configura la URL del Script para poder editar estados');
                updateHistorial(); // Revert
                return;
            }
            
            const nuevoEstado = selectElement.value;
            const tipo = selectElement.getAttribute('data-tipo');
            const fecha = selectElement.getAttribute('data-fecha');
            const cliente = selectElement.getAttribute('data-cliente');
            const cantidad = selectElement.getAttribute('data-cantidad');
            
            if (!confirm(`¬øCambiar estado de "${cliente}" a ${nuevoEstado}?`)) {
                updateHistorial(); // Revert
                return;
            }
            
            // Convertir fecha a formato DD/MM/YYYY si viene en otro formato
            let fechaFormateada = fecha;
            if (fecha.includes('-')) {
                const parts = fecha.split('-');
                fechaFormateada = parts[2] + '/' + parts[1] + '/' + parts[0];
            }
            
            const data = {
                action: 'update_status',
                tipo: tipo,
                fecha: fechaFormateada,
                cliente: cliente,
                cantidad: parseFloat(cantidad.replace('$', '')),
                nuevoEstado: nuevoEstado,
                usuario: currentUser
            };
            
            console.log('Enviando:', data);
            
            try {
                const response = await fetch(config.scriptUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data),
                    redirect: 'follow'
                });
                
                // Con mode no-cors no podemos leer la respuesta, pero si no hay error de red, asumimos √©xito
                console.log('Respuesta recibida');
                alert('‚úÖ Estado actualizado a ' + nuevoEstado + '\n\nVerifica en tu planilla que se haya actualizado.');
                
                // Recargar datos despu√©s de 2 segundos
                setTimeout(() => loadData(), 2000);
                
            } catch (error) {
                console.error('Error completo:', error);
                alert('‚ùå Error de red al actualizar.\n\n' +
                      'Verifica:\n' +
                      '1. Que la URL del Script sea correcta\n' +
                      '2. Que el Script est√© implementado correctamente\n' +
                      '3. Tu conexi√≥n a internet\n\n' +
                      'Error: ' + error.message);
                updateHistorial(); // Revert
            }
        }
        
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screen + '-screen').classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById('nav-' + screen).classList.add('active');
            
            // Restaurar fondo morado para dashboard y config
            if (screen === 'dashboard' || screen === 'config') {
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
            // Si vamos a historial, aplicar color seg√∫n tab actual
            else if (screen === 'historial') {
                if (currentTab === 'ventas') {
                    document.body.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                } else {
                    document.body.style.background = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)';
                }
            }
            // Si vamos a cargar, aplicar color seg√∫n tipo actual
            else if (screen === 'cargar') {
                if (currentTipo === 'VENTA') {
                    document.body.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                } else {
                    document.body.style.background = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)';
                }
            }
        }
        
        function switchTab(tab) {
            currentTab = tab;
            
            const body = document.body;
            
            if (tab === 'ventas') {
                document.getElementById('tab-ventas').classList.add('active');
                document.getElementById('tab-compras').classList.remove('active');
                document.getElementById('ventas-tab').classList.remove('hidden');
                document.getElementById('compras-tab').classList.add('hidden');
                // Fondo verde
                body.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
            } else {
                document.getElementById('tab-ventas').classList.remove('active');
                document.getElementById('tab-compras').classList.add('active');
                document.getElementById('ventas-tab').classList.add('hidden');
                document.getElementById('compras-tab').classList.remove('hidden');
                // Fondo rojo
                body.style.background = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)';
            }
        }
        
        function changeFilter(filter) {
            currentFilter = filter;
            updateHistorial();
        }
        
        function setTipo(tipo) {
            currentTipo = tipo;
            
            const body = document.body;
            const submitBtn = document.getElementById('btn-submit');
            
            if (tipo === 'VENTA') {
                document.getElementById('tipo-venta').classList.add('active');
                document.getElementById('tipo-compra').classList.remove('active');
                submitBtn.textContent = 'Registrar VENTA';
                submitBtn.classList.remove('compra');
                // Fondo verde suave
                body.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
            } else {
                document.getElementById('tipo-venta').classList.remove('active');
                document.getElementById('tipo-compra').classList.add('active');
                submitBtn.textContent = 'Registrar COMPRA';
                submitBtn.classList.add('compra');
                // Fondo rojo suave
                body.style.background = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)';
            }
        }
        
        function calcularTotal() {
            const cantidad = parseFloat(document.getElementById('form-cantidad').value) || 0;
            const precio = parseFloat(document.getElementById('form-precio').value) || 0;
            const total = cantidad * precio;
            
            if (total > 0) {
                document.getElementById('total-preview').classList.remove('hidden');
                document.getElementById('total-preview-value').textContent = '$' + total.toLocaleString('es-AR');
            } else {
                document.getElementById('total-preview').classList.add('hidden');
            }
        }
        
        async function agregarOperacion() {
            const submitBtn = document.getElementById('btn-submit');
            
            // Prevenir m√∫ltiples clicks
            if (submitBtn.disabled) return;
            
            if (!config.scriptUrl) {
                alert('Configura la URL del Script en Config');
                return;
            }
            
            const cliente = document.getElementById('form-cliente').value.trim();
            const cantidad = parseFloat(document.getElementById('form-cantidad').value);
            const precio = parseFloat(document.getElementById('form-precio').value);
            
            if (!cliente || !cantidad || !precio) {
                alert('Completa todos los campos');
                return;
            }
            
            const fecha = document.getElementById('form-fecha').value;
            const observaciones = document.getElementById('form-observaciones').value;
            const total = cantidad * precio;
            
            const data = {
                tipo: currentTipo,
                fecha: fecha,
                operador: currentUser,
                cliente: cliente,
                cantidad: cantidad,
                precio: precio,
                total: total,
                observaciones: observaciones
            };
            
            // Deshabilitar bot√≥n y cambiar texto
            submitBtn.disabled = true;
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '‚è≥ Guardando...';
            submitBtn.style.opacity = '0.6';
            
            try {
                await fetch(config.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                alert('‚úÖ ' + currentTipo + ' agregada');
                
                document.getElementById('form-cliente').value = '';
                document.getElementById('form-cantidad').value = '';
                document.getElementById('form-precio').value = '';
                document.getElementById('form-observaciones').value = '';
                document.getElementById('total-preview').classList.add('hidden');
                
                setTimeout(() => loadData(), 2000);
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                // Re-habilitar bot√≥n
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    submitBtn.style.opacity = '1';
                }, 2000);
            }
        }
        
        function saveConfig() {
            const apiKey = document.getElementById('config-api-key').value.trim();
            const scriptUrl = document.getElementById('config-script-url').value.trim();
            
            if (!apiKey) {
                alert('Ingresa la API Key');
                return;
            }
            
            config.apiKey = apiKey;
            config.scriptUrl = scriptUrl;
            localStorage.setItem('apiKey', apiKey);
            localStorage.setItem('scriptUrl', scriptUrl);
            
            const successMsg = document.getElementById('config-success');
            successMsg.classList.remove('hidden');
            setTimeout(() => successMsg.classList.add('hidden'), 3000);
        }
        
        async function testScriptConnection() {
            const scriptUrl = document.getElementById('config-script-url').value.trim();
            
            if (!scriptUrl) {
                alert('‚ö†Ô∏è Primero ingresa la URL del Script');
                return;
            }
            
            if (!scriptUrl.includes('/exec')) {
                alert('‚ö†Ô∏è La URL debe terminar en /exec');
                return;
            }
            
            const testData = {
                action: 'test',
                message: 'Prueba de conexi√≥n desde la app'
            };
            
            try {
                console.log('Probando conexi√≥n a:', scriptUrl);
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData),
                    redirect: 'follow'
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                alert('‚úÖ Conexi√≥n exitosa!\n\n' +
                      'La URL del Script funciona correctamente.\n' +
                      'Status: ' + response.status);
                
            } catch (error) {
                console.error('Error de prueba:', error);
                alert('‚ùå Error de conexi√≥n\n\n' +
                      'No se pudo conectar con el Script.\n\n' +
                      'Verifica:\n' +
                      '1. La URL est√© correcta\n' +
                      '2. El Script est√© implementado\n' +
                      '3. Permisos: "Anyone" puede acceder\n\n' +
                      'Error: ' + error.message);
            }
        }
    </script>
</body>
</html>
